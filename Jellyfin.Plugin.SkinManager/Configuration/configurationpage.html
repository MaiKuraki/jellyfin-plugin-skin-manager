<!DOCTYPE html>
<html>
    

<head>
    <title>Skin Manager</title>
</head>

<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage tbsConfigurationPage"
         data-require="emby-input,emby-button">
        <div data-role="content">
            <div class="content-primary">
                <form class="tbsConfigurationPage">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Skin Manager</h2>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank"
                           href="https://github.com/danieladov/jellyfin-plugin-skin-manager">Help</a>
                    </div>
                    <div class="verticalSection">
                        <p>
                            Select the skin you want to install and click Set Skin
                        </p>
                        <br />
                    </div>

                    <div class="selectContainer">
                        <label for="css">Skin</label>
                        <select is="emby-select" id="cssOptions" onchange="updateSelectors()">                          
                        </select>
                        <br />

                        <div class="fieldDescription" id="description"></div>
                    </div>

                    <div class="checkboxList checkboxList-verticalwrap" id ="options">
                        
                    </div>
                            <br />
                        <button is="emby-button" type="button" class="raised block" id="refresh-library"
                                    onclick=setSkin()>
                                <span>Set Skin</span>
                            </button>


                            
</form>
            </div>
        </div>

        
        <script type="text/javascript">
            var data;
            $.getJSON('https://raw.githubusercontent.com/danieladov/jellyfin-plugin-skin-manager/cssEditor/skins-3.0.json', function(json) {
                data=json;
                loadSkins();           
            });

            function loadSkins(){          

                var cssOptions = document.getElementById("cssOptions");
                var skinVersions = document.getElementById("skinVersions");
                var versionDescription = document.getElementById("versionDescription");
                data.forEach(element => {
                    var opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(element.name));
                    opt.value=element.defaultCss;
                    cssOptions.appendChild(opt);
                    
                });
               updateSelectors()
                  
            }



            function loadOptions(options){
                var page = $.mobile.activePage;
                var html = "";
                        html += '<div data-role="controlgroup">';
                        options.forEach(element=>{
                            if(element.type == "checkBox"){
                                html += getCheckBox(element);
                            }else if(element.type == "colorPicker"){
                                html += getColorPicker(element);
                            }else if(element.type == "number"){
                                html += getNumber(element);
                            }else if(element.type = "selector"){
                                html += getSelector(element);
                            }
                           
                        });
                        html += '</div>';
                        $('#options', page).html(html).trigger('create');

            }

             function getCheckBox ( option) {
                        var html = "";
                            var id = "chkFolder" ;
                            var name = option.name;
                            var value = option.css;
                            var description = option.description;                         
                            //html += '<label><input is="emby-checkbox" class="chkLibrary" type="checkbox" data-mini="true" id="' + id + '" name="' + id + '" data-value="' + value + '" '+' /><span>' + name  + '</span></label>';
                            html += '<div class="checkboxContainer checkboxContainer-withDescription"><label><input type="checkbox" is="emby-checkbox" id="' + id + '"name="' + id + '" data-value="' + value + '" '+' /><span>'+ name +'</span></label><div class="fieldDescription checkboxFieldDescription">'+description+'</div></div>'
                        return html;
                    }

            function getColorPicker ( option) {
                var html = "";
                    var id = "favcolor" ;
                    var name = option.name;   
                    var defaultValue = option.default;
                    var css = option.css;
                    var description = option.description;                              
                    html += '<div class="inputContainer"><input style="height: 1em; padding: 0px; border: none;" type=color  class = "color" value="' + defaultValue + '"data-css = "'+ css+ '" data-mini="true" id="' + id + '" name="' + id + '" label="'+name +'"  /><div class="fieldDescription">'+description+'</div></div>';
                        
                return html;
                    }

            function getNumber(option){
                var html = "";
                    var id = "number" ;
                    var name = option.name; 
                    var css = option.css;
                    var step = option.step==undefined?1:option.step;
                    var defaultValue = option.default;
                    var description = option.description;                           
                    //html += '<label for=number><input is="emby-input" type=number value=' + defaultValue + ' class = "number" data-css = "'+ css+ '" +  data-mini="true" id="' + id + '" name="' + id + '" data-name="' + name + '" ' + ' /><span>' + name  + '</span></label><br>';
                    html += '<div class="inputContainer"><input is="emby-input" type="number" class = "number" value=' + defaultValue + ' step=' + step + ' data-css = "'+ css+ '" + id="' + id + '" name="' + id + '"  min="1" max="300" label="'+name +'" /><div class="fieldDescription">'+description+'</div></div>'
                        
                return html;
            } 
            
            function getSelector(option){
                var html = "";
                    var id = "selector" ;
                    var name = option.name; 
                    var css = option.css;
                    var defaultValue = option.default;
                    var description = option.description;                           
                    //html += '<label for=number><input is="emby-input" type=number value=' + defaultValue + ' class = "number" data-css = "'+ css+ '" +  data-mini="true" id="' + id + '" name="' + id + '" data-name="' + name + '" ' + ' /><span>' + name  + '</span></label><br>';
                    html += '<div class="selectContainer"><select is="emby-select"  data-css= "'+css + '"class="selector" label="'+name+'">' + getOptions(option)+'</select></div>'
                        
                return html;

            }

            function getOptions(option){
                var html = "";
                var selections = option.selections
                var css = option.css;
                selections.forEach(element=>{
                    var name = element.name;                 
                    html+= '<option data-css= "'+css + '"value='+name+'>'+ name +'</option>'
                })
                return html;                        
                   
            }
            

            function updateVersions(){
                var selected = $('#cssOptions').val();
                var skinVersions = document.getElementById("skinVersions");
                

                //clear selector
                for (i = skinVersions.options.length-1; i >= 0; i--) {
                    skinVersions.options[i] = null;
                }

                    var skinVersions = document.getElementById("skinVersions");

                    data.forEach(element => {
                        if(selected == element.name){
                            element.versions.forEach(version =>{
                                var opt = document.createElement("option");
                                opt.appendChild(document.createTextNode(version.name));
                                opt.value=version.css;
                                skinVersions.appendChild(opt);
                                description.innerHTML=version.description;


                        })
                        }
                        

                    });
                    updateDescription()   
            }

            function updateDescription( ){
                var description = document.getElementById("description");
                var selected = $('#cssOptions').val();

                    data.forEach(element => {          
                        if(element.defaultCss == selected){
                            description.innerHTML=element.description;
                        }                       
                        
                    })           
            }

            function createCss(){
                //process checkbox
                var css = $('#cssOptions').val();
                var selectedOptions = $('.chkLibrary:checked').map(function () {
                        return this.getAttribute('data-value');
                    }).get();

                //proccess selector
                var selectors = document.getElementsByClassName("selector");
                for (let element of selectors) {
                    css += element.getAttribute("data-css").replaceAll("$",element.value)
                
                }

                //process colorPicker
                selectedOptions.forEach(element=>{
                    css += element;
                })
                
                var colorPickers = document.getElementsByClassName("color");
                for (let element of colorPickers) {
                    var color = hexToRgb( element.value);
                    rgbColor = color.r + "," +color.g +"," + color.b
                    css+= element.getAttribute("data-css").replaceAll("$",rgbColor);
                }

                //procces number selector
                var numberSelectors = document.getElementsByClassName("number");
                for (let element of numberSelectors) {
                    css+= element.getAttribute("data-css").replaceAll("$",element.value);
                }

                


                return css;
                       

            }
            function updateSelectors(){
                var selected = $('#cssOptions').val();
                data.forEach(element=>{
                    if(element.defaultCss == selected){
                              loadOptions(element.options);
                              updateDescription();
                            }    
                })
            }

            function setSkin() {
                

            ApiClient.getServerConfiguration().then(function (config) {
  
                ApiClient.updateServerConfiguration(config).then(function() {
                ApiClient.getNamedConfiguration('branding').then(function(brandingConfig) {
                    brandingConfig.CustomCss = createCss();

                    

                    ApiClient.updateNamedConfiguration('branding', brandingConfig).then(function () {
                        Dashboard.processServerConfigurationUpdateResult();
                        window.location.reload(true);
                        
                    });
                });
               
            });
        
            
        });  
          
    }

    function hexToRgb(hex) {
            // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });

            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
            }

        </script>

        <script type="text/javascript">
            var plugin = {
            guid: 'e9ca8b8e-ca6d-40e7-85dc-58e536df8eb3'
            };

            $('#configPage').on('pageshow', function () {
            Dashboard.showLoadingMsg();
            loadSavedConfig();
            ApiClient.getPluginConfiguration(plugin.guid).then(function (config) {
                $('#cssOptions').val(config.selectedCss).change();
                Dashboard.hideLoadingMsg();
                });
            });

            $('#configForm').on('submit', function () {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(plugin.guid).then(function (config) {
                config.selectedCss = $('#cssOptions').val();
                ApiClient.updatePluginConfiguration(plugin.guid, config).then(function (result) {
                    Dashboard.processPluginConfigurationUpdateResult(result);
             });
            });

            return false;
            });

            
            

            

                
            
       </script>

       <style>
           .color2{
            
            display: block;
            margin: 0;
            margin-bottom: 0 !important;
            font-family: inherit;
            font-weight: inherit;
            padding: 0.4em 0.25em;

            /* must the 16px or larger to prevent iOS page zoom on focus */
            font-size: 110%;

            /* prevent padding from causing width overflow */
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            outline: none !important;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            width: 100%;
        
           }


       </style>
    </div>
</body>

</html>